
#########Stopping App services###############

- name: copy the powershell files to local system
  win_copy:
    src: script/powershell.ps1
    dest: C:\temp\powershell.ps1
    
- name: Getting the list of services which are running
  win_shell: C:\temp\powershell.ps1
  register: running_services
  
- name: setting a variable to create powershell script
  set_fact:
    services_list: "{{running_services.stdout_lines | list }}"
    
- name: Stopping the services in the list
  # win_shell: 'sc.exe stop "{{item}}" <application> 4 "Planned"'
  win_service:
    name: "{{item}}"
    state: stopped
  register: Stopped_services
  #loop: "{{running_services.stdout_lines.split(',') | trim }}"
  loop: "{{running_services.stdout_lines}}"
  delegate_to: "{{app_server}}" 
  ignore_errors: true
    
- name: Waiting for the all the services to be stopped
  wait_for:
    timeout: 60
  delegate_to: localhost


###################Stopping SQL Service#######################


- name: Run command to stop SQL Server
  win_command: NET stop MSSQLSERVER /y
  register: sql_service_stopped
  win_wait_for:
    timeout: 60
  delegate_to: "{{db_server}}"


- name: Run command ro restart SQL Server
  win_command: shutdown /r
  delegate_to: "{{app_server}}" 

- name: Wait For
  win_wait_for: 
    port: 5986
    state: present
    timeout: 30 



######################Rebooting DB Server##############################


- name: Run command ro restart SQL Server
  win_command: shutdown /r
  delegate_to: "{{db_server}}" 

- name: WAIT FOR 
  win_wait_for: 
    port: 5986
    state: present
    timeout: 30 
    
  
######################Starting SQL service##################


- name: Waiting for sql service to be started
  win_wait_for:
    timeout: 60
  delegate_to: "{{db_server}}"
  # delegate_to: localhost



##########################Starting App Services##########################
  
- name: Starting the services in the list
  win_service:
    name: "{{item}}"
    state: started
  # win_shell: 'sc.exe start "{{item}}"'
  register: started_services
  loop: "{{running_services.stdout_lines}}"
  delegate_to: "{{app_server}}"
  ignore_errors: true
  
- name: Waiting for the all the services to be started
  wait_for:
    timeout: 120
  delegate_to: localhost
